#include <stdio.h>
#include <stdlib.h>
#include "gifdec.h"
#include "gifdec.c"

// PAWSv2 RGBM Palette for colour matching
uint32_t PAWSpalette[256] = {
    0x000000,0x240024,0x000049,0x24006d,0x000092,0x2400b6,0x0000db,0x2400ff,0x002400,0x242424,0x002449,0x24246d,0x002492,0x2424b6,0x0024db,0x2424ff,
    0x004900,0x244924,0x004949,0x24496d,0x004992,0x2449b6,0x0049db,0x2449ff,0x006d00,0x246d24,0x006d49,0x246d6d,0x006d92,0x246db6,0x006ddb,0x246dff,
    0x009200,0x249224,0x009249,0x24926d,0x009292,0x2492b6,0x0092db,0x2492ff,0x00b600,0x24b624,0x00b649,0x24b66d,0x00b692,0x24b6b6,0x00b6db,0x24b6ff,
    0x00db00,0x24db24,0x00db49,0x24db6d,0x00db92,0x24dbb6,0x00dbdb,0x24dbff,0x00ff00,0x24ff24,0x00ff49,0x24ff6d,0x00ff92,0x24ffb6,0x00ffdb,0x24ffff,
    0x000000,0x6d0024,0x490049,0x6d006d,0x490092,0x6d00b6,0x4900db,0x6d00ff,0x492400,0x6d2424,0x492449,0x6d246d,0x492492,0x6d24b6,0x4924db,0x6d24ff,
    0x494900,0x6d4924,0x494949,0x6d496d,0x494992,0x6d49b6,0x4949db,0x6d49ff,0x496d00,0x6d6d24,0x496d49,0x6d6d6d,0x496d92,0x6d6db6,0x496ddb,0x6d6dff,
    0x499200,0x6d9224,0x499249,0x6d926d,0x499292,0x6d92b6,0x4992db,0x6d92ff,0x49b600,0x6db624,0x49b649,0x6db66d,0x49b692,0x6db6b6,0x49b6db,0x6db6ff,
    0x49db00,0x6ddb24,0x49db49,0x6ddb6d,0x49db92,0x6ddbb6,0x49dbdb,0x6ddbff,0x49ff00,0x6dff24,0x49ff49,0x6dff6d,0x49ff92,0x6dffb6,0x49ffdb,0x6dffff,
    0x920000,0xb60024,0x920049,0xb6006d,0x920092,0xb600b6,0x9200db,0xb600ff,0x922400,0xb62424,0x922449,0xb6246d,0x922492,0xb624b6,0x9224db,0xb624ff,
    0x924900,0xb64924,0x924949,0xb6496d,0x924992,0xb649b6,0x9249db,0xb649ff,0x926d00,0xb66d24,0x926d49,0xb66d6d,0x926d92,0xb66db6,0x926ddb,0xb66dff,
    0x929200,0xb69224,0x929249,0xb6926d,0x929292,0xb692b6,0x9292db,0xb692ff,0x92b600,0xb6b624,0x92b649,0xb6b66d,0x92b692,0xb6b6b6,0x92b6db,0xb6b6ff,
    0x92db00,0xb6db24,0x92db49,0xb6db6d,0x92db92,0xb6dbb6,0x92dbdb,0xb6dbff,0x92ff00,0xb6ff24,0x92ff49,0xb6ff6d,0x92ff92,0xb6ffb6,0x92ffdb,0xb6ffff,
    0xdb0000,0xff0024,0xdb0049,0xff006d,0xdb0092,0xff00b6,0xdb00db,0xff00ff,0xdb2400,0xff2424,0xdb2449,0xff246d,0xdb2492,0xff24b6,0xdb24db,0xff24ff,
    0xdb4900,0xff4924,0xdb4949,0xff496d,0xdb4992,0xff49b6,0xdb49db,0xff49ff,0xdb6d00,0xff6d24,0xdb6d49,0xff6d6d,0xdb6d92,0xff6db6,0xdb6ddb,0xff6dff,
    0xdb9200,0xff9224,0xdb9249,0xff926d,0xdb9292,0xff92b6,0xdb92db,0xff92ff,0xdbb600,0xffb624,0xdbb649,0xffb66d,0xdbb692,0xffb6b6,0xdbb6db,0xffb6ff,
    0xdbdb00,0xffdb24,0xdbdb49,0xffdb6d,0xdbdb92,0xffdbb6,0xdbdbdb,0xffdbff,0xdbff00,0xffff24,0xdbff49,0xffff6d,0xdbff92,0xffffb6,0xdbffdb,0xffffff
};

// Match RGB colour to palette index
uint8_t matchcolour( uint8_t *colour ) {
    uint32_t colour32;

    colour32 = ( colour[0] << 16 ) + ( colour[1] << 8 ) + colour[2];
    for( int i = 0; i < 256; i++ ) {
        if( colour32 == PAWSpalette[i] ) {
            return((uint8_t)i);
        }
    }
    printf("FAIL: %0x6x ",colour32);
    return( 0x40 );
}

int main(int argc, char *argv[]) {
    gd_GIF *gif;
    char title[32] = {0};
    uint8_t *colour, *frame;

    if (argc < 2) {
        fprintf(stderr, "usage:\n  %s gif-file [t]\n", argv[0]);
        return 1;
    }
    gif = gd_open_gif(argv[1]);
    if (!gif) {
        fprintf(stderr, "Could not open %s\n", argv[1]);
        return 1;
    }
    frame = malloc(gif->width * gif->height * 3);
    if (!frame) {
        fprintf(stderr, "Could not allocate frame\n");
        return 1;
    }

    while (gd_get_frame(gif)) {
        gd_render_frame(gif, frame);
        colour = frame;
        printf("        ");
        for( int y = 0; y < gif->height; y++ ) {
            for( int x = 0; x < gif->width; x++ ) {
                if(gd_is_bgcolor(gif,colour) && ( argc == 3 )) {
                    printf("64, ");
                } else {
                    printf("%d, ", matchcolour( colour ));
                }
                colour += 3;
                if( ( x & 0xf ) == 0xf ) printf("\n        ");
            }
        }
    }

    free(frame);
    gd_close_gif(gif);
    return 0;
}
